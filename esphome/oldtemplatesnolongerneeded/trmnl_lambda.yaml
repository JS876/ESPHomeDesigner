# ============================================================================
# Official TRMNL (ESP32-C3) - ESPHome Configuration Template
# ============================================================================
# DEVICE: Official TRMNL e-Paper Display (ESP32-C3 based)
#         - Display: 7.5" Waveshare e-Paper (800x480, Monochrome)
#         - Battery: Yes (LiPo with ADC on GPIO0)
#         - Buttons: None (no user buttons on TRMNL)
#         - Buzzer: None
# ============================================================================
# INSTRUCTIONS:
#
# STEP 1: Copy the Material Design Icons font file
#         - From this repo: font_ttf/font_ttf/materialdesignicons-webfont.ttf
#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf
#         (Create the fonts folder if it doesn't exist)
#
# STEP 2: Create a new device in ESPHome
#         - Click "New Device"
#         - Name: trmnl (or your choice)
#         - Select: ESP32-C3
#         - ESPHome will auto-generate a basic config
#         - IMPORTANT: Ensure board is 'esp32-c3-devkitm-1'
#
# STEP 3: Copy the "HARDWARE SECTIONS" below (from ▼ START to ▲ END)
#         Paste them AFTER the captive_portal: line in your ESPHome config
#
# STEP 4: Design your dashboard in Home Assistant
#         - Open the reTerminal Dashboard integration
#         - Select "Official TRMNL (ESP32-C3)" in Device Settings
#         - Click "Save Layout" when done
#         - Click "Generate Snippet"
#
# STEP 5: From the generated snippet, copy ONLY these sections:
#         - globals:
#         - font:
#         - text_sensor: (only if you used sensor_text widgets)
#         - script: (if generated)
#         - display:
#         Paste them at the end of your config
#
# ============================================================================

# ============================================================================
# EXAMPLE: ESPHome Auto-Generated Config (you will have this already)
# ============================================================================
# This is what ESPHome creates automatically. DON'T copy this - it's just
# an example to show you what sections you already have.
#
# esphome:
#   name: trmnl
#   friendly_name: TRMNL Display
#
# IMPORTANT: Add this on_boot section to initialize the display!
esphome:
  name: trmnl-dashboard
  friendly_name: Official TRMNL
  # Limit compilation to 1 process to prevent OOM errors with large fonts
  compile_process_limit: 1
  on_boot:
    priority: 600
    then:
      - delay: 2s
      # - component.update: epaper_display  <-- REMOVED to prevent boot loop with heavy layouts
      - script.execute: manage_run_and_sleep
#
# esp32:
#   board: esp32-c3-devkitm-1
#   framework:
#     type: esp-idf
#
# logger:
#
# api:
#   encryption:
#     key: "your_auto_generated_key_here"
#
# ota:
#   - platform: esphome
#     password: "your_auto_generated_password_here"
#
# wifi:
#   ssid: !secret wifi_ssid
#   password: !secret wifi_password
#   fast_connect: true      # Recommended for faster connection
#   power_save_mode: NONE   # Recommended for stability
#   ap:
#     ssid: "TRMNL Fallback Hotspot"
#     password: "auto_generated_password"
#
# captive_portal:
#
# ============================================================================

# ============================================================================
# ▼▼▼ START: HARDWARE SECTIONS - COPY FROM HERE ▼▼▼
# ============================================================================
# Copy everything between the ▼▼▼ START and ▲▲▲ END markers
# Paste it in your ESPHome config AFTER the "captive_portal:" line
# ============================================================================

substitutions:
  # Display Settings for Official TRMNL (ESP32-C3)
  # Pin mapping from TRMNL firmware: https://github.com/usetrmnl/trmnl-firmware
  display_model: 7.50inv2
  display_cs_pin: GPIO6
  display_dc_pin: GPIO5
  display_reset_pin: GPIO10
  display_busy_pin: GPIO4

globals:
  # Navigation & Refresh Logic
  - id: display_page
    type: int
    restore_value: true
    initial_value: '0'

  # Default page refresh interval (seconds)
  - id: page_refresh_default_s
    type: int
    restore_value: no
    initial_value: '900'

  # Current computed refresh interval (seconds)
  - id: page_refresh_current_s
    type: int
    restore_value: no
    initial_value: '900'

  - id: battery_glyph
    type: std::string
    restore_value: no
    initial_value: '"\U000F0079"'

# Note: ESP32-C3 does not support Octal PSRAM, so the 'psram:' section is omitted.

# Required for Online Image / Puppet widgets
http_request:
  verify_ssl: false
  timeout: 20s

time:
  - platform: homeassistant
    id: ha_time

# I2C Bus (Optional, for external sensors)
i2c:
  sda: GPIO1
  scl: GPIO2
  scan: true

# SPI Bus for Display
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO8

# Note: No 'output' or 'rtttl' sections as TRMNL has no buzzer.

sensor:
  # Battery Voltage (ADC on GPIO0)
  - platform: adc
    pin: GPIO0
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 60s
    attenuation: 11db
    filters:
      # The voltage divider on TRMNL is typically 100k/100k (factor of 2)
      - multiply: 2.0 
      - round: 2

  - platform: template
    name: "Battery Level"
    id: battery_level
    lambda: 'return id(battery_voltage).state;'
    unit_of_measurement: "%"
    device_class: battery
    update_interval: 60s
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 3.30 -> 0.0
          - 4.15 -> 100.0
      - clamp:
          min_value: 0
          max_value: 100
      - round: 0

  - platform: wifi_signal
    name: "WiFi Signal Strength"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"

# No 'binary_sensor' section as TRMNL has no user buttons.

button:
  # Virtual buttons for Home Assistant control
  - platform: template
    name: "TRMNL Next Page"
    id: trmnl_next_page
    on_press:
      - lambda: |-
          int pages = 5; // Default, will be overridden by generated script if used
          id(display_page) = (id(display_page) + 1) % pages;
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Previous Page"
    id: trmnl_prev_page
    on_press:
      - lambda: |-
          int pages = 5;
          id(display_page) = (id(display_page) - 1 + pages) % pages;
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Refresh Display"
    id: trmnl_refresh_display
    on_press:
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Go to Page 1"
    id: trmnl_goto_page_0
    on_press:
      - lambda: 'id(display_page) = 0;'
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Go to Page 2"
    id: trmnl_goto_page_1
    on_press:
      - lambda: 'id(display_page) = 1;'
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Go to Page 3"
    id: trmnl_goto_page_2
    on_press:
      - lambda: 'id(display_page) = 2;'
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Go to Page 4"
    id: trmnl_goto_page_3
    on_press:
      - lambda: 'id(display_page) = 3;'
      - component.update: epaper_display

  - platform: template
    name: "TRMNL Go to Page 5"
    id: trmnl_goto_page_4
    on_press:
      - lambda: 'id(display_page) = 4;'
      - component.update: epaper_display

# ============================================================================
# ▲▲▲ END: HARDWARE SECTIONS - COPY UNTIL HERE ▲▲▲
# ============================================================================


# ============================================================================
# STEP 5: Paste generated sections from Home Assistant editor
# ============================================================================
# After designing your dashboard:
# 1. Click "Save Layout"
# 2. From the generated code, copy ONLY these sections and paste them below:
#
#    ✓ font:         (always generated)
#    ✓ text_sensor:  (ONLY if you used sensor_text widgets)
#                    If generated, ADD these to the sensor: section above
#                    (don't create a duplicate sensor: section)
#    ✓ button:       (always generated - includes page navigation)
#    ✓ script:       (always generated for page refresh)
#    ✓ display:      (always generated - complete display configuration)
#
#    ✗ DO NOT COPY from generated code (already in hardware template above):
#      - sensor: (template already has battery sensor)
#      - time:
#
# IMPORTANT: If the generated code includes text_sensor: entries,
# you can paste them here as a separate section. They won't conflict
# with the sensor: section above.
#
# Example of what to paste:
#
#
# font:
#   - file: "gfonts://Material+Design+Icons"
#     id: mdi_48
#     size: 48
#     glyphs: ["\U000F0595"]
#
# text_sensor:
#   - platform: homeassistant
#     id: weather_forecast_home
#     entity_id: weather.forecast_home
#     internal: true
#
# script:
#   - id: manage_run_and_sleep
#     mode: restart
#     then:
#       # ... refresh logic ...
#
# display:
#   - platform: waveshare_epaper
#     id: epaper_display
#     model: ${display_model}
#     cs_pin: ${display_cs_pin}
#     dc_pin: ${display_dc_pin}
#     reset_pin:
#       number: ${display_reset_pin}
#       inverted: false
#     busy_pin:
#       number: ${display_busy_pin}
#       inverted: true
#     update_interval: never
#     lambda: |-
#       int page = id(display_page);
#       if (page == 0) {
#         // your widgets here
#       }
#
# ============================================================================
# ← PASTE YOUR GENERATED CODE HERE (font, text_sensor, script, display)
# ============================================================================
